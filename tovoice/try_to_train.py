import torch
import os
import numpy as np
import torch.nn.functional as F
from autovc import get_generator
from pathlib import Path
from preprocessing import pad_seq


print("Please enter Speaker Name : ")
spkr_name = input()
print(spkr_name)

def get_specs_n_embs(spkr_name):

    spc_list = []
    emb_list = []

    SOURCE_FILE = Path(__file__).resolve()
    SOURCE_DIR = SOURCE_FILE.parent
    ROOT_DIR = SOURCE_DIR.parent
    emb_dir = ROOT_DIR /"tovoice/data/speaker-embeddings"
    specs_dir = ROOT_DIR / "tovoice/data/spectrograms"

    _, _, file_list_a = next(os.walk(os.path.join(specs_dir,spkr_name)))
    for a in file_list_a:
        x_r, _ = pad_seq((np.load(os.path.join(specs_dir,spkr_name, a))))
        x_r = torch.from_numpy(x_r[np.newaxis, :, :])
        spc_list.append(x_r)

    emb_x_1 = torch.load(os.path.join(emb_dir,spkr_name))
    for a in spc_list:
        emb_list.append(emb_x_1)

    return spc_list, emb_list

G = get_generator()
loss_list = []
Optm = torch.optim.Adam(G.parameters(), 0.0001)

spc_list, emb_list = get_specs_n_embs(spkr_name)

for idx, (x_r, emb_org) in enumerate(zip(spc_list, emb_list)):

    print(idx)
    # Identity mapping loss
    x_identic, x_identic_psnt, code_real = G(x_r, emb_org, emb_org)
    x_identic = x_identic.squeeze(0)
    x_identic_psnt = x_identic_psnt.squeeze(0)

    g_loss_id = F.mse_loss(x_r, x_identic)
    g_loss_id_psnt = F.mse_loss(x_r, x_identic_psnt)

    # Code semantic loss.
    code_reconst = G(x_identic_psnt, emb_org, None)
    g_loss_cd = F.l1_loss(code_real, code_reconst)

    # Backward and optimize.
    g_loss = g_loss_id + g_loss_id_psnt + g_loss_cd
    Optm.zero_grad()
    g_loss.backward()
    Optm.step()

    # Logging.
    loss = {}
    loss['G/loss_id'] = g_loss_id.item()
    loss['G/loss_id_psnt'] = g_loss_id_psnt.item()
    loss['G/loss_cd'] = g_loss_cd.item()
    loss_list.append(loss)

    torch.save(G.state_dict(), 'generator_syn.ckpt')

print(loss_list)


# {'G/loss_id': 0.028817132115364075, 'G/loss_id_psnt': 0.02869652397930622, 'G/loss_cd': 0.021553821861743927} - one spc/ one emb
# {'G/loss_id': 0.0399833619594574, 'G/loss_id_psnt': 0.038182333111763, 'G/loss_cd': 0.028943698853254318} - 8th loss on Eddie
# {'G/loss_id': 0.021501479670405388, 'G/loss_id_psnt': 0.0217124056071043, 'G/loss_cd': 0.01098670531064272}

""" Jimmy_Fallon
[{'G/loss_id': 0.061649929732084274, 'G/loss_id_psnt': 0.06105722859501839, 'G/loss_cd': 0.03880155459046364},
{'G/loss_id': 0.07322098314762115, 'G/loss_id_psnt': 0.07209904491901398, 'G/loss_cd': 0.04113372415304184},
{'G/loss_id': 0.061381369829177856, 'G/loss_id_psnt': 0.06032250076532364, 'G/loss_cd': 0.0411558672785759},
{'G/loss_id': 0.05131221562623978, 'G/loss_id_psnt': 0.050088509917259216, 'G/loss_cd': 0.03554918244481087},
{'G/loss_id': 0.05829805135726929, 'G/loss_id_psnt': 0.05639960616827011, 'G/loss_cd': 0.03653181344270706},
{'G/loss_id': 0.058936379849910736, 'G/loss_id_psnt': 0.05663222074508667, 'G/loss_cd': 0.03436904773116112},
{'G/loss_id': 0.047251250594854355, 'G/loss_id_psnt': 0.045424338430166245, 'G/loss_cd': 0.034342970699071884},
{'G/loss_id': 0.04213796928524971, 'G/loss_id_psnt': 0.039838507771492004, 'G/loss_cd': 0.029466014355421066},
{'G/loss_id': 0.031812138855457306, 'G/loss_id_psnt': 0.0298539400100708, 'G/loss_cd': 0.026904188096523285},
{'G/loss_id': 0.04473130777478218, 'G/loss_id_psnt': 0.04215696454048157, 'G/loss_cd': 0.026372529566287994},
{'G/loss_id': 0.031160781159996986, 'G/loss_id_psnt': 0.028827980160713196, 'G/loss_cd': 0.02598218061029911},
{'G/loss_id': 0.03692226484417915, 'G/loss_id_psnt': 0.03410784900188446, 'G/loss_cd': 0.024371471256017685},
{'G/loss_id': 0.033417459577322006, 'G/loss_id_psnt': 0.030597787350416183, 'G/loss_cd': 0.025180410593748093},
{'G/loss_id': 0.03522064536809921, 'G/loss_id_psnt': 0.032483212649822235, 'G/loss_cd': 0.02261888049542904},
{'G/loss_id': 0.038690730929374695, 'G/loss_id_psnt': 0.035593610256910324, 'G/loss_cd': 0.024132786318659782},
{'G/loss_id': 0.03705379366874695, 'G/loss_id_psnt': 0.034260135143995285, 'G/loss_cd': 0.023069189861416817},
{'G/loss_id': 0.034002456814050674, 'G/loss_id_psnt': 0.03131197765469551, 'G/loss_cd': 0.021388325840234756},
{'G/loss_id': 0.023351341485977173, 'G/loss_id_psnt': 0.021099824458360672, 'G/loss_cd': 0.018549112603068352},
{'G/loss_id': 0.0265444815158844, 'G/loss_id_psnt': 0.024238061159849167, 'G/loss_cd': 0.018826641142368317},
{'G/loss_id': 0.02103343792259693, 'G/loss_id_psnt': 0.019113801419734955, 'G/loss_cd': 0.01622052676975727},
{'G/loss_id': 0.022532159462571144, 'G/loss_id_psnt': 0.020501786842942238, 'G/loss_cd': 0.016935082152485847},
{'G/loss_id': 0.02113858237862587, 'G/loss_id_psnt': 0.019250882789492607, 'G/loss_cd': 0.016833119094371796},
{'G/loss_id': 0.03011750616133213, 'G/loss_id_psnt': 0.028186054900288582, 'G/loss_cd': 0.01850324310362339},
{'G/loss_id': 0.020749589428305626, 'G/loss_id_psnt': 0.01896165870130062, 'G/loss_cd': 0.01568697579205036},
{'G/loss_id': 0.02154027298092842, 'G/loss_id_psnt': 0.019816240295767784, 'G/loss_cd': 0.015721751376986504},
{'G/loss_id': 0.030273020267486572, 'G/loss_id_psnt': 0.0284336619079113, 'G/loss_cd': 0.017318136990070343},
{'G/loss_id': 0.015908800065517426, 'G/loss_id_psnt': 0.014486304484307766, 'G/loss_cd': 0.013967032544314861},
{'G/loss_id': 0.021519822999835014, 'G/loss_id_psnt': 0.020343279466032982, 'G/loss_cd': 0.01395861804485321},
{'G/loss_id': 0.017978206276893616, 'G/loss_id_psnt': 0.01659303344786167, 'G/loss_cd': 0.013534418307244778},
{'G/loss_id': 0.01592022366821766, 'G/loss_id_psnt': 0.01461631990969181, 'G/loss_cd': 0.013814340345561504},
{'G/loss_id': 0.01937476545572281, 'G/loss_id_psnt': 0.017867647111415863, 'G/loss_cd': 0.015279375948011875},
{'G/loss_id': 0.028197376057505608, 'G/loss_id_psnt': 0.026567548513412476, 'G/loss_cd': 0.015869250521063805},
{'G/loss_id': 0.0250381026417017, 'G/loss_id_psnt': 0.0233761053532362, 'G/loss_cd': 0.017306651920080185},
{'G/loss_id': 0.017801284790039062, 'G/loss_id_psnt': 0.017037302255630493, 'G/loss_cd': 0.01426704041659832},
{'G/loss_id': 0.031955163925886154, 'G/loss_id_psnt': 0.030570020899176598, 'G/loss_cd': 0.01736963726580143},
{'G/loss_id': 0.025112377479672432, 'G/loss_id_psnt': 0.024687381461262703, 'G/loss_cd': 0.014934860169887543},
{'G/loss_id': 0.018973572179675102, 'G/loss_id_psnt': 0.018613141030073166, 'G/loss_cd': 0.013275214470922947},
{'G/loss_id': 0.02075464464724064, 'G/loss_id_psnt': 0.019423238933086395, 'G/loss_cd': 0.01666095480322838},
{'G/loss_id': 0.019907381385564804, 'G/loss_id_psnt': 0.018445519730448723, 'G/loss_cd': 0.016431469470262527},
{'G/loss_id': 0.017616357654333115, 'G/loss_id_psnt': 0.01710035465657711, 'G/loss_cd': 0.015131115913391113},
{'G/loss_id': 0.018549537286162376, 'G/loss_id_psnt': 0.018298564478754997, 'G/loss_cd': 0.014710331335663795},
{'G/loss_id': 0.0291423499584198, 'G/loss_id_psnt': 0.028953207656741142, 'G/loss_cd': 0.015291760675609112},
{'G/loss_id': 0.020424405112862587, 'G/loss_id_psnt': 0.020026538521051407, 'G/loss_cd': 0.016471728682518005},
{'G/loss_id': 0.023014642298221588, 'G/loss_id_psnt': 0.02280677855014801, 'G/loss_cd': 0.015583401545882225},
{'G/loss_id': 0.0171100702136755, 'G/loss_id_psnt': 0.016365325078368187, 'G/loss_cd': 0.013762831687927246},
{'G/loss_id': 0.01805267296731472, 'G/loss_id_psnt': 0.016653764992952347, 'G/loss_cd': 0.015985455363988876},
{'G/loss_id': 0.022261442616581917, 'G/loss_id_psnt': 0.021720828488469124, 'G/loss_cd': 0.014584911055862904},
{'G/loss_id': 0.01703823357820511, 'G/loss_id_psnt': 0.015975849702954292, 'G/loss_cd': 0.016372451558709145},
{'G/loss_id': 0.026716582477092743, 'G/loss_id_psnt': 0.02572677657008171, 'G/loss_cd': 0.01575825735926628},
{'G/loss_id': 0.01379088032990694, 'G/loss_id_psnt': 0.013280456885695457, 'G/loss_cd': 0.012131799012422562},
{'G/loss_id': 0.0202739629894495, 'G/loss_id_psnt': 0.01951068453490734, 'G/loss_cd': 0.014189107343554497},
{'G/loss_id': 0.021440813317894936, 'G/loss_id_psnt': 0.020939288660883904, 'G/loss_cd': 0.014144835062325},
{'G/loss_id': 0.017027512192726135, 'G/loss_id_psnt': 0.016820194199681282, 'G/loss_cd': 0.013038656674325466},
{'G/loss_id': 0.024996813386678696, 'G/loss_id_psnt': 0.02449086867272854, 'G/loss_cd': 0.015408583916723728},
{'G/loss_id': 0.022371597588062286, 'G/loss_id_psnt': 0.02201087959110737, 'G/loss_cd': 0.01469663716852665},
{'G/loss_id': 0.02083016373217106, 'G/loss_id_psnt': 0.020529525354504585, 'G/loss_cd': 0.013210729695856571},
{'G/loss_id': 0.018862109631299973, 'G/loss_id_psnt': 0.018281251192092896, 'G/loss_cd': 0.015432589687407017},
{'G/loss_id': 0.014365707524120808, 'G/loss_id_psnt': 0.01416004728525877, 'G/loss_cd': 0.014093373902142048},
{'G/loss_id': 0.014673077501356602, 'G/loss_id_psnt': 0.014106489717960358, 'G/loss_cd': 0.015777891501784325},
{'G/loss_id': 0.014178684912621975, 'G/loss_id_psnt': 0.013886996544897556, 'G/loss_cd': 0.014604411087930202},
{'G/loss_id': 0.02208077907562256, 'G/loss_id_psnt': 0.02214435674250126, 'G/loss_cd': 0.01187851745635271}]
"""

""" Andy Samberg
[{'G/loss_id': 0.029438327997922897, 'G/loss_id_psnt': 0.029373688623309135, 'G/loss_cd': 0.024499841034412384},
{'G/loss_id': 0.020601077005267143, 'G/loss_id_psnt': 0.020263589918613434, 'G/loss_cd': 0.01739158108830452},
{'G/loss_id': 0.03127357363700867, 'G/loss_id_psnt': 0.03120294027030468, 'G/loss_cd': 0.024001682177186012},
{'G/loss_id': 0.025905290618538857, 'G/loss_id_psnt': 0.02512202225625515, 'G/loss_cd': 0.02289644256234169},
{'G/loss_id': 0.026103539392352104, 'G/loss_id_psnt': 0.025428008288145065, 'G/loss_cd': 0.022273896262049675},
{'G/loss_id': 0.02192302606999874, 'G/loss_id_psnt': 0.02175959385931492, 'G/loss_cd': 0.024023283272981644},
{'G/loss_id': 0.022418351843953133, 'G/loss_id_psnt': 0.02158670872449875, 'G/loss_cd': 0.020048825070261955},
{'G/loss_id': 0.0220786165446043, 'G/loss_id_psnt': 0.02135368064045906, 'G/loss_cd': 0.01816205307841301},
{'G/loss_id': 0.025325195863842964, 'G/loss_id_psnt': 0.024316905066370964, 'G/loss_cd': 0.022214002907276154},
{'G/loss_id': 0.020044393837451935, 'G/loss_id_psnt': 0.018990153446793556, 'G/loss_cd': 0.018235448747873306},
{'G/loss_id': 0.02374262362718582, 'G/loss_id_psnt': 0.022929290309548378, 'G/loss_cd': 0.021298488602042198},
{'G/loss_id': 0.019647737964987755, 'G/loss_id_psnt': 0.01890943944454193, 'G/loss_cd': 0.019092824310064316},
{'G/loss_id': 0.018557799980044365, 'G/loss_id_psnt': 0.017692629247903824, 'G/loss_cd': 0.017350519075989723},
{'G/loss_id': 0.012649022042751312, 'G/loss_id_psnt': 0.012610265053808689, 'G/loss_cd': 0.01285482943058014},
{'G/loss_id': 0.018514448776841164, 'G/loss_id_psnt': 0.018004518002271652, 'G/loss_cd': 0.0169166661798954},
{'G/loss_id': 0.012398332357406616, 'G/loss_id_psnt': 0.01282486505806446, 'G/loss_cd': 0.012866538017988205},
{'G/loss_id': 0.0192984938621521, 'G/loss_id_psnt': 0.018808437511324883, 'G/loss_cd': 0.01862584613263607},
{'G/loss_id': 0.013177674263715744, 'G/loss_id_psnt': 0.012676108628511429, 'G/loss_cd': 0.01550060510635376},
{'G/loss_id': 0.013169624842703342, 'G/loss_id_psnt': 0.013759124092757702, 'G/loss_cd': 0.014269798994064331},
{'G/loss_id': 0.02195623703300953, 'G/loss_id_psnt': 0.022222725674510002, 'G/loss_cd': 0.019966255873441696},
{'G/loss_id': 0.0156476441770792, 'G/loss_id_psnt': 0.01558392308652401, 'G/loss_cd': 0.01632372848689556},
{'G/loss_id': 0.019656559452414513, 'G/loss_id_psnt': 0.01927318051457405, 'G/loss_cd': 0.01879238337278366},
{'G/loss_id': 0.01801781915128231, 'G/loss_id_psnt': 0.017690908163785934, 'G/loss_cd': 0.018477680161595345},
{'G/loss_id': 0.010778157971799374, 'G/loss_id_psnt': 0.01091285701841116, 'G/loss_cd': 0.013085995800793171},
{'G/loss_id': 0.015332439914345741, 'G/loss_id_psnt': 0.014869533479213715, 'G/loss_cd': 0.014695154502987862},
{'G/loss_id': 0.01738855242729187, 'G/loss_id_psnt': 0.016900401562452316, 'G/loss_cd': 0.01581674814224243},
{'G/loss_id': 0.018589166924357414, 'G/loss_id_psnt': 0.018202776089310646, 'G/loss_cd': 0.01793886348605156},
{'G/loss_id': 0.015834584832191467, 'G/loss_id_psnt': 0.015450682491064072, 'G/loss_cd': 0.017961813136935234},
{'G/loss_id': 0.014561406336724758, 'G/loss_id_psnt': 0.01425582729279995, 'G/loss_cd': 0.014347024261951447},
{'G/loss_id': 0.016485847532749176, 'G/loss_id_psnt': 0.016193099319934845, 'G/loss_cd': 0.016544921323657036},
{'G/loss_id': 0.01503018382936716, 'G/loss_id_psnt': 0.014754248782992363, 'G/loss_cd': 0.014503708109259605},
{'G/loss_id': 0.022243233397603035, 'G/loss_id_psnt': 0.02195669896900654, 'G/loss_cd': 0.020932428538799286},
{'G/loss_id': 0.012598183006048203, 'G/loss_id_psnt': 0.012275975197553635, 'G/loss_cd': 0.014974589459598064},
{'G/loss_id': 0.02361220307648182, 'G/loss_id_psnt': 0.022870611399412155, 'G/loss_cd': 0.021427273750305176},
{'G/loss_id': 0.01518471259623766, 'G/loss_id_psnt': 0.0146913081407547, 'G/loss_cd': 0.015182668343186378},
{'G/loss_id': 0.019121477380394936, 'G/loss_id_psnt': 0.01824280619621277, 'G/loss_cd': 0.01915206015110016},
{'G/loss_id': 0.014158979058265686, 'G/loss_id_psnt': 0.0136973075568676, 'G/loss_cd': 0.01574326679110527},
{'G/loss_id': 0.01682748645544052, 'G/loss_id_psnt': 0.015897149220108986, 'G/loss_cd': 0.01853770576417446},
{'G/loss_id': 0.013696156442165375, 'G/loss_id_psnt': 0.013810292817652225, 'G/loss_cd': 0.016347551718354225},
{'G/loss_id': 0.01425512321293354, 'G/loss_id_psnt': 0.014206184074282646, 'G/loss_cd': 0.0151045061647892},
{'G/loss_id': 0.018739799037575722, 'G/loss_id_psnt': 0.01845434494316578, 'G/loss_cd': 0.016099587082862854},
{'G/loss_id': 0.021178321912884712, 'G/loss_id_psnt': 0.020090246573090553, 'G/loss_cd': 0.016982434317469597},
{'G/loss_id': 0.00963086262345314, 'G/loss_id_psnt': 0.009766122326254845, 'G/loss_cd': 0.01322463620454073},
{'G/loss_id': 0.02390393242239952, 'G/loss_id_psnt': 0.022895704954862595, 'G/loss_cd': 0.022789716720581055},
{'G/loss_id': 0.013605152256786823, 'G/loss_id_psnt': 0.013566922396421432, 'G/loss_cd': 0.014287453144788742},
{'G/loss_id': 0.017067117616534233, 'G/loss_id_psnt': 0.017424333840608597, 'G/loss_cd': 0.015126580372452736},
{'G/loss_id': 0.013444696553051472, 'G/loss_id_psnt': 0.013145224191248417, 'G/loss_cd': 0.015983952209353447},
{'G/loss_id': 0.014768563210964203, 'G/loss_id_psnt': 0.014690835028886795, 'G/loss_cd': 0.014766637235879898},
{'G/loss_id': 0.01666698046028614, 'G/loss_id_psnt': 0.016477536410093307, 'G/loss_cd': 0.015615279786288738},
{'G/loss_id': 0.014314459636807442, 'G/loss_id_psnt': 0.014503080397844315, 'G/loss_cd': 0.01443172711879015},
{'G/loss_id': 0.010064966045320034, 'G/loss_id_psnt': 0.009748272597789764, 'G/loss_cd': 0.012804534286260605},
{'G/loss_id': 0.012064692564308643, 'G/loss_id_psnt': 0.011873374693095684, 'G/loss_cd': 0.013973819091916084},
{'G/loss_id': 0.017964918166399002, 'G/loss_id_psnt': 0.016847984865307808, 'G/loss_cd': 0.02031611278653145},
{'G/loss_id': 0.010913065634667873, 'G/loss_id_psnt': 0.010775143280625343, 'G/loss_cd': 0.012071805074810982},
{'G/loss_id': 0.011062413454055786, 'G/loss_id_psnt': 0.010849721729755402, 'G/loss_cd': 0.013843887485563755},
{'G/loss_id': 0.011797233484685421, 'G/loss_id_psnt': 0.011723585426807404, 'G/loss_cd': 0.014351977035403252},
{'G/loss_id': 0.010558637790381908, 'G/loss_id_psnt': 0.01031841617077589, 'G/loss_cd': 0.010973967611789703},
{'G/loss_id': 0.01416440587490797, 'G/loss_id_psnt': 0.013841859064996243, 'G/loss_cd': 0.014308225363492966},
{'G/loss_id': 0.013450714759528637, 'G/loss_id_psnt': 0.013089142739772797, 'G/loss_cd': 0.014105376787483692},
{'G/loss_id': 0.013972987420856953, 'G/loss_id_psnt': 0.013623163104057312, 'G/loss_cd': 0.01576041243970394},
{'G/loss_id': 0.015050004236400127, 'G/loss_id_psnt': 0.014824519865214825, 'G/loss_cd': 0.015030496753752232},
{'G/loss_id': 0.01391733530908823, 'G/loss_id_psnt': 0.013107371516525745, 'G/loss_cd': 0.01860647462308407},
{'G/loss_id': 0.012085641734302044, 'G/loss_id_psnt': 0.011706715449690819, 'G/loss_cd': 0.015856795012950897},
{'G/loss_id': 0.01484611164778471, 'G/loss_id_psnt': 0.014070731587707996, 'G/loss_cd': 0.019817078486084938},
{'G/loss_id': 0.02101368084549904, 'G/loss_id_psnt': 0.02013253979384899, 'G/loss_cd': 0.01980564370751381}]"""
